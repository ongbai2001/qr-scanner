<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üì¶ Qu√©t QR - L∆∞u Tr·ªØ ƒê∆°n H√†ng</title>
    <link rel="manifest" href="/manifest.json">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            font-size: 24px;
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }
        .stats div {
            text-align: center;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 30%;
        }
        .actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        button {
            padding: 15px;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .order-container {
            margin-top: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .order-page {
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 15px;
        }
        .order-page:last-child {
            border-bottom: none;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 10px;
        }
        .modal video {
            width: 80%;
            max-width: 400px;
        }
        .modal .close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            color: white;
            cursor: pointer;
        }
        .modal p {
            color: white;
            font-size: 18px;
        }
        input {
            padding: 10px;
            width: 100%;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>üì¶ Qu√©t QR - L∆∞u Tr·ªØ ƒê∆°n H√†ng</h1>
    <p style="text-align: center;">Qu·∫£n l√Ω ƒë∆°n h√†ng th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠ m·ªôt c√°ch d·ªÖ d√†ng</p>

    <div class="stats">
        <div>
            <h3 id="totalOrders">0</h3>
            <p>T·ªïng ƒë∆°n h√†ng</p>
        </div>
        <div>
            <h3 id="todayOrders">0</h3>
            <p>H√¥m nay</p>
        </div>
        <div>
            <h3 id="totalValue">0ƒë</h3>
            <p>T·ªïng gi√° tr·ªã</p>
        </div>
    </div>

    <div class="actions">
        <div>
            <button id="startScan">üîç Qu√©t QR Code</button>
            <p>Qu√©t m√£ QR ƒë·ªÉ th√™m ƒë∆°n h√†ng m·ªõi</p>
        </div>
        <div>
            <input type="text" id="searchInput" placeholder="üîé T√¨m ki·∫øm ƒë∆°n h√†ng">
        </div>
        <div>
            <button id="exportButton">üì§ Xu·∫•t d·ªØ li·ªáu (CSV)</button>
        </div>
    </div>

    <div class="order-container" id="orderContainer">
        <!-- C√°c √¥ ƒë∆°n h√†ng s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
    </div>

    <div class="modal">
        <span class="close">‚úï</span>
        <p>H∆∞·ªõng camera v√†o m√£ QR ƒë·ªÉ qu√©t</p>
    </div>

    <script>
        // Kh·ªüi t·∫°o Firebase (Thay b·∫±ng c·∫•u h√¨nh c·ªßa b·∫°n)
        const firebaseConfig = {
            apiKey: "AIzaSyD-MjMnmrCuZhEwacmeXXiTppMB42p9Epg",
            authDomain: "phu117.firebaseapp.com",
            projectId: "phu117",
            storageBucket: "phu117.firebasestorage.app",
            messagingSenderId: "612585313910",
            appId: "1:612585313910:web:ae5815ac048f861a4eb157"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Kh·ªüi t·∫°o m·∫£ng ƒë∆°n h√†ng
        let orders = [];
        let filteredOrders = [];

        // L·∫•y d·ªØ li·ªáu t·ª´ Firestore
        async function fetchOrders() {
            const snapshot = await db.collection('orders').orderBy('timestamp', 'desc').get();
            orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            filteredOrders = [...orders];
            renderOrders();
        }

        // Render danh s√°ch ƒë∆°n h√†ng theo ph√¢n trang (20 ƒë∆°n h√†ng m·ªói √¥)
        function renderOrders() {
            const orderContainer = document.getElementById('orderContainer');
            orderContainer.innerHTML = '';

            for (let i = 0; i < filteredOrders.length; i += 20) {
                const pageOrders = filteredOrders.slice(i, i + 20);
                const orderPage = document.createElement('div');
                orderPage.className = 'order-page';
                orderPage.innerHTML = pageOrders.map(order => `<p>üì¶ ${order.content} - ${new Date(order.timestamp).toLocaleString()}</p>`).join('');
                orderContainer.appendChild(orderPage);
            }

            updateStats();
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats() {
            document.getElementById('totalOrders').textContent = orders.length;
            document.getElementById('todayOrders').textContent = orders.filter(order => {
                const date = new Date(order.timestamp);
                return date.toDateString() === new Date().toDateString();
            }).length;
            document.getElementById('totalValue').textContent = orders.reduce((sum, order) => sum + (order.value || 0), 0) + 'ƒë';
        }

        // X·ª≠ l√Ω qu√©t QR
        document.getElementById('startScan').addEventListener('click', () => {
            const modal = document.querySelector('.modal');
            const video = document.createElement('video');
            video.autoplay = true;
            modal.innerHTML = '';
            modal.appendChild(video);

            const closeBtn = document.createElement('span');
            closeBtn.className = 'close';
            closeBtn.textContent = '‚úï';
            modal.appendChild(closeBtn);

            const message = document.createElement('p');
            message.textContent = 'H∆∞·ªõng camera v√†o m√£ QR ƒë·ªÉ qu√©t';
            modal.appendChild(message);

            modal.style.display = 'block';

            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    video.srcObject = stream;
                    setTimeout(async () => {
                        const qrData = `ƒê∆°n h√†ng #${orders.length + 1} - Gi√°: 100000ƒë`;
                        const newOrder = { content: qrData, timestamp: new Date().toISOString(), value: 100000 };
                        await db.collection('orders').add(newOrder);
                        orders.push(newOrder);
                        filteredOrders = [...orders];
                        renderOrders();
                        modal.style.display = 'none';
                        stream.getTracks().forEach(track => track.stop());
                    }, 2000);
                })
                .catch(err => {
                    console.error('L·ªói camera:', err);
                    modal.style.display = 'none';
                });
        });

        // ƒê√≥ng modal
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('close')) {
                const modal = document.querySelector('.modal');
                const video = modal.querySelector('video');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(track => track.stop());
                }
                modal.style.display = 'none';
            }
        });

        // T√¨m ki·∫øm ƒë∆°n h√†ng
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const keyword = e.target.value.toLowerCase();
            filteredOrders = orders.filter(order => order.content.toLowerCase().includes(keyword));
            renderOrders();
        });

        // Xu·∫•t CSV
        document.getElementById('exportButton').addEventListener('click', () => {
            const csv = orders.map(order => `${order.content},${new Date(order.timestamp).toLocaleString()},${order.value}`).join('\n');
            const blob = new Blob([`Content,Timestamp,Value\n${csv}`], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'orders.csv';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Kh·ªüi t·∫°o
        fetchOrders();
    </script>
</body>
</html>
